name: Build AppImage for Fedora

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build AppImage in Fedora container
        run: |
          # Pull Fedora container and mount the repo
          podman run --rm -v $PWD:/workspace:Z -w /workspace docker.io/library/fedora:latest bash -c '
            set -e

            # Install dependencies
            dnf install -y fuse fuse-libs patchelf unzip wget desktop-file-utils \
            libX11 libXext libXrender libXcursor libXrandr libXfixes libXcomposite \
            libXdamage libXinerama libXScrnSaver nss alsa-lib xdg-utils \
            glibc-langpack-en

            # Download linuxdeploy and appimage plugin
            mkdir -p appimage-out
            cd appimage-out

            wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
            chmod +x linuxdeploy-x86_64.AppImage

            wget -q https://github.com/linuxdeploy/linuxdeploy-plugin-appimage/releases/download/continuous/linuxdeploy-plugin-appimage-x86_64.AppImage
            chmod +x linuxdeploy-plugin-appimage-x86_64.AppImage

            # Build the AppImage (adjust for your app)
            ./linuxdeploy-x86_64.AppImage \
              --appdir AppDir \
              --desktop-file ../your-app.desktop \
              --icon-file ../your-icon.png \
              --executable ../Popcorn-Time \
              --output appimage \
              --plugin appimage
          '

      - name: Upload AppImage artifact
        uses: actions/upload-artifact@v4
        with:
          name: PopcornTime.AppImage
          path: appimage-out/*.AppImage
